<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dublin Housing Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        :root {
            --bg: #0a0a0a;
            --surface: #141414;
            --border: #2a2a2a;
            --text: #e0e0e0;
            --text-dim: #808080;
            --accent: #00ff88;
            --accent-dim: #00aa55;
            --warn: #ffaa00;
            --danger: #ff4444;
            --blue: #4488ff;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg);
            color: var(--text);
            font-size: 12px;
            line-height: 1.4;
        }
        .header {
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        .header h1 {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .header-stats {
            display: flex;
            gap: 24px;
            font-size: 11px;
        }
        .header-stat { color: var(--text-dim); }
        .header-stat strong { color: var(--text); margin-left: 4px; }
        .container { padding: 12px; max-width: 1800px; margin: 0 auto; }

        /* Stats row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }
        .stat {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 10px 12px;
        }
        .stat-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 18px; font-weight: 700; color: var(--accent); margin-top: 2px; }
        .stat-sub { font-size: 10px; color: var(--text-dim); margin-top: 2px; }

        /* Filters */
        .filters {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 12px;
            margin-bottom: 12px;
        }
        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: flex-end;
        }
        .filter-group { display: flex; flex-direction: column; gap: 4px; }
        .filter-group label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; }
        .filter-group input, .filter-group select {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 8px;
            font-family: inherit;
            font-size: 11px;
            min-width: 120px;
        }
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: var(--accent);
        }
        .btn {
            background: var(--accent);
            color: var(--bg);
            border: none;
            padding: 6px 12px;
            font-family: inherit;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
        }
        .btn:hover { background: var(--accent-dim); }
        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
        }
        .btn-ghost:hover { border-color: var(--text); color: var(--text); }
        .filter-count {
            font-size: 11px;
            color: var(--text-dim);
            margin-left: auto;
        }
        .filter-count strong { color: var(--accent); }

        /* Grid */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
        }
        .card-header {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header h2 { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .card-body { padding: 12px; }
        .card-badge { font-size: 10px; color: var(--text-dim); }

        #map { height: 300px; }
        .chart-container { height: 220px; }

        /* Table */
        .table-card { background: var(--surface); border: 1px solid var(--border); }
        .table-scroll { max-height: 500px; overflow: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { padding: 6px 8px; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; }
        th {
            background: var(--bg);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            position: sticky;
            top: 0;
            cursor: pointer;
        }
        th:hover { color: var(--text); }
        tr:hover { background: rgba(0,255,136,0.03); }

        /* Score badges */
        .score { font-weight: 600; padding: 2px 6px; font-size: 10px; }
        .score-hot { background: var(--accent); color: var(--bg); }
        .score-warm { background: var(--warn); color: var(--bg); }
        .score-cool { background: var(--border); color: var(--text-dim); }

        .price { color: var(--accent); font-weight: 600; }
        .days-old { color: var(--danger); }
        .days-new { color: var(--accent); }
        .ber-good { color: var(--accent); }
        .ber-ok { color: var(--warn); }
        .ber-bad { color: var(--danger); }

        a { color: var(--blue); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Insights */
        .insights { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .insight {
            background: var(--surface);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            padding: 8px 12px;
            font-size: 11px;
            flex: 1;
            min-width: 200px;
        }
        .insight.warn { border-left-color: var(--warn); }
        .insight strong { color: var(--accent); }
        .insight.warn strong { color: var(--warn); }

        /* Mobile */
        @media (max-width: 600px) {
            .header { flex-direction: column; align-items: flex-start; }
            .header-stats { flex-wrap: wrap; gap: 12px; }
            .filters-row { flex-direction: column; }
            .filter-group { width: 100%; }
            .filter-group input, .filter-group select { width: 100%; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            table { font-size: 10px; }
            th, td { padding: 4px 6px; }
        }

        /* Leaflet overrides */
        .leaflet-container { background: var(--bg); }
        .leaflet-popup-content-wrapper { background: var(--surface); color: var(--text); border-radius: 0; }
        .leaflet-popup-tip { background: var(--surface); }
    </style>
</head>
<body>
    <header class="header">
        <h1>Dublin Housing Tracker</h1>
        <div class="header-stats">
            <div class="header-stat">Properties:<strong id="headerTotal">-</strong></div>
            <div class="header-stat">Median:<strong id="headerMedian">-</strong></div>
            <div class="header-stat">Hot Picks:<strong id="headerHot">-</strong></div>
            <div class="header-stat">Stale (90d+):<strong id="headerStale">-</strong></div>
        </div>
    </header>

    <div class="container">
        <div class="insights" id="insights"></div>

        <div class="filters">
            <div class="filters-row">
                <div class="filter-group">
                    <label>Location</label>
                    <input type="text" id="filterLocation" placeholder="area name...">
                </div>
                <div class="filter-group">
                    <label>Max Price</label>
                    <select id="filterPrice">
                        <option value="">any</option>
                        <option value="300000">€300k</option>
                        <option value="400000">€400k</option>
                        <option value="500000">€500k</option>
                        <option value="600000">€600k</option>
                        <option value="700000">€700k</option>
                        <option value="800000">€800k</option>
                        <option value="1000000">€1M</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Beds</label>
                    <select id="filterBeds">
                        <option value="">any</option>
                        <option value="2">2+</option>
                        <option value="3">3+</option>
                        <option value="4">4+</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Type</label>
                    <select id="filterType">
                        <option value="">any</option>
                        <option value="Detached">detached</option>
                        <option value="Semi">semi-d</option>
                        <option value="Terrace">terrace</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>BER</label>
                    <select id="filterBer">
                        <option value="">any</option>
                        <option value="A">A</option>
                        <option value="B">B+</option>
                        <option value="C">C+</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Score</label>
                    <select id="filterDesire">
                        <option value="">any</option>
                        <option value="hot">hot only</option>
                        <option value="warm">warm+</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Days</label>
                    <select id="filterDays">
                        <option value="">any</option>
                        <option value="new">new (7d)</option>
                        <option value="recent">recent (30d)</option>
                        <option value="stale">stale (90d+)</option>
                    </select>
                </div>
                <button class="btn" onclick="applyFilters()">Filter</button>
                <button class="btn btn-ghost" onclick="resetFilters()">Reset</button>
                <div class="filter-count">
                    <strong id="filteredCount">0</strong> / <span id="totalCount">0</span>
                </div>
            </div>
        </div>

        <div class="stats-row">
            <div class="stat"><div class="stat-label">Median €/m²</div><div class="stat-value" id="statPPS">-</div></div>
            <div class="stat"><div class="stat-label">Avg Days</div><div class="stat-value" id="statDays">-</div></div>
            <div class="stat"><div class="stat-label">Price Range</div><div class="stat-value" id="statRange">-</div></div>
            <div class="stat"><div class="stat-label">Hot Deals</div><div class="stat-value" id="statHot">-</div></div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-header"><h2>Map</h2><span class="card-badge">green=hot, yellow=warm, gray=cool</span></div>
                <div class="card-body"><div id="map"></div></div>
            </div>
            <div class="card">
                <div class="card-header"><h2>Price Distribution</h2></div>
                <div class="card-body"><div class="chart-container"><canvas id="priceChart"></canvas></div></div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-header"><h2>Area Demand</h2><span class="card-badge">by avg days on market</span></div>
                <div class="card-body"><div class="chart-container"><canvas id="areaChart"></canvas></div></div>
            </div>
            <div class="card">
                <div class="card-header"><h2>Time on Market</h2><span class="card-badge">90d+ = negotiable</span></div>
                <div class="card-body"><div class="chart-container"><canvas id="daysChart"></canvas></div></div>
            </div>
        </div>

        <div class="table-card">
            <div class="card-header"><h2>Properties</h2><span class="card-badge">click headers to sort</span></div>
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">Score</th>
                            <th onclick="sortTable(1)">Address</th>
                            <th onclick="sortTable(2)">Price</th>
                            <th onclick="sortTable(3)">€/m²</th>
                            <th onclick="sortTable(4)">Beds</th>
                            <th onclick="sortTable(5)">m²</th>
                            <th onclick="sortTable(6)">Type</th>
                            <th onclick="sortTable(7)">BER</th>
                            <th onclick="sortTable(8)">Days</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
let allData = [], filteredData = [], areaStats = {}, map, markers, priceChart, areaChart, daysChart;

async function loadData() {
    const response = await fetch('dublin_houses.csv');
    const text = await response.text();
    const lines = text.trim().split('\n');
    const headers = parseCSVLine(lines[0]);

    allData = lines.slice(1).map(line => {
        const values = parseCSVLine(line);
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i] || '');
        obj.priceNum = parseInt(obj.price.replace(/[^0-9]/g, '')) || 0;
        obj.bedsNum = parseInt(obj.beds) || 0;
        obj.sizeNum = parseFloat(obj.size_sqm) || 0;
        obj.daysNum = parseInt(obj.days_on_market) || 0;
        obj.lat = parseFloat(obj.latitude) || 0;
        obj.lng = parseFloat(obj.longitude) || 0;
        obj.pricePerSqm = obj.sizeNum > 0 ? Math.round(obj.priceNum / obj.sizeNum) : 0;
        obj.area = extractArea(obj.address);
        return obj;
    }).filter(d => d.priceNum > 0);

    areaStats = {};
    allData.forEach(d => {
        if (!areaStats[d.area]) areaStats[d.area] = { days: [], pps: [] };
        if (d.daysNum > 0) areaStats[d.area].days.push(d.daysNum);
        if (d.pricePerSqm > 0) areaStats[d.area].pps.push(d.pricePerSqm);
    });

    const allDays = allData.filter(d => d.daysNum > 0).map(d => d.daysNum);
    const medianDays = allDays.sort((a,b) => a-b)[Math.floor(allDays.length / 2)] || 60;

    Object.keys(areaStats).forEach(area => {
        const s = areaStats[area];
        s.avgDays = s.days.length ? s.days.reduce((a,b) => a+b, 0) / s.days.length : medianDays;
        s.avgPPS = s.pps.length ? s.pps.reduce((a,b) => a+b, 0) / s.pps.length : 0;
        s.demandScore = Math.max(0, Math.min(100, 100 - (s.avgDays / medianDays * 50)));
    });

    allData.forEach(d => { d.desirability = calcDesirability(d); });
    filteredData = [...allData];
    initDashboard();
}

function calcDesirability(d) {
    let score = 0;
    const area = areaStats[d.area] || {};
    score += (area.demandScore || 50) * 0.40;
    if (d.pricePerSqm > 0 && area.avgPPS > 0) {
        const r = d.pricePerSqm / area.avgPPS;
        score += (r < 0.8 ? 100 : r < 0.95 ? 75 : r < 1.1 ? 50 : 25) * 0.25;
    } else score += 50 * 0.25;
    const berScores = { A: 100, B: 80, C: 60, D: 40, E: 25, F: 15, G: 10 };
    score += (d.ber ? (berScores[d.ber[0]] || 30) : 30) * 0.20;
    const typeScores = { Detached: 100, 'Semi-D': 85, Semi: 85, Bungalow: 80, Terrace: 70, End: 75 };
    let ts = 60;
    for (const [t, p] of Object.entries(typeScores)) { if (d.property_type?.includes(t)) { ts = p; break; } }
    score += ts * 0.15;
    if (score >= 70) return { score: Math.round(score), level: 'hot' };
    if (score >= 50) return { score: Math.round(score), level: 'warm' };
    return { score: Math.round(score), level: 'cool' };
}

function parseCSVLine(line) {
    const r = []; let c = '', q = false;
    for (let i = 0; i < line.length; i++) {
        if (line[i] === '"') q = !q;
        else if (line[i] === ',' && !q) { r.push(c.trim()); c = ''; }
        else c += line[i];
    }
    r.push(c.trim()); return r;
}

function extractArea(addr) {
    const p = addr.split(',');
    if (p.length >= 2) { let a = p[p.length - 2].trim().replace(/Dublin \d+/gi, '').trim(); return a || p[p.length-2].trim(); }
    return 'Dublin';
}

function initDashboard() { updateStats(); genInsights(); initMap(); initCharts(); renderTable(); }

function updateStats() {
    const d = filteredData;
    const prices = d.map(x => x.priceNum).sort((a,b) => a-b);
    const pps = d.filter(x => x.pricePerSqm > 0).map(x => x.pricePerSqm).sort((a,b) => a-b);
    const days = d.filter(x => x.daysNum > 0).map(x => x.daysNum);
    const hot = d.filter(x => x.desirability.level === 'hot').length;
    const stale = d.filter(x => x.daysNum >= 90).length;

    document.getElementById('headerTotal').textContent = d.length;
    document.getElementById('totalCount').textContent = allData.length;
    document.getElementById('filteredCount').textContent = d.length;
    document.getElementById('headerHot').textContent = hot;
    document.getElementById('headerStale').textContent = stale;
    document.getElementById('statHot').textContent = hot;

    if (prices.length) {
        const med = prices[Math.floor(prices.length / 2)];
        document.getElementById('headerMedian').textContent = '€' + (med/1000).toFixed(0) + 'k';
        document.getElementById('statRange').textContent = (prices[0]/1000).toFixed(0) + 'k-' + (prices[prices.length-1]/1e6).toFixed(1) + 'M';
    }
    if (pps.length) document.getElementById('statPPS').textContent = '€' + pps[Math.floor(pps.length/2)].toLocaleString();
    if (days.length) document.getElementById('statDays').textContent = Math.round(days.reduce((a,b)=>a+b,0)/days.length);
}

function genInsights() {
    const c = document.getElementById('insights'); c.replaceChildren();
    const topAreas = Object.entries(areaStats).filter(([_,v]) => v.days.length >= 3)
        .sort((a,b) => b[1].demandScore - a[1].demandScore).slice(0,3).map(([a]) => a);
    if (topAreas.length) {
        const div = document.createElement('div'); div.className = 'insight';
        div.innerHTML = '<strong>Hottest areas:</strong> ' + topAreas.join(', ');
        c.appendChild(div);
    }
    const stale = filteredData.filter(x => x.daysNum >= 90).length;
    if (stale) {
        const div = document.createElement('div'); div.className = 'insight warn';
        div.innerHTML = '<strong>' + stale + '</strong> properties 90+ days — negotiation targets';
        c.appendChild(div);
    }
    const newL = filteredData.filter(x => x.daysNum <= 7).length;
    if (newL) {
        const div = document.createElement('div'); div.className = 'insight';
        div.innerHTML = '<strong>' + newL + '</strong> new this week';
        c.appendChild(div);
    }
}

function initMap() {
    map = L.map('map').setView([53.33, -6.26], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '©OSM ©CartoDB' }).addTo(map);
    markers = L.markerClusterGroup({
        iconCreateFunction: cl => L.divIcon({
            html: '<div style="background:#00ff88;color:#000;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font:bold 11px monospace;">' + cl.getChildCount() + '</div>',
            className: '', iconSize: [28, 28]
        })
    });
    updateMapMarkers(); map.addLayer(markers);
}

function updateMapMarkers() {
    markers.clearLayers();
    filteredData.forEach(d => {
        if (d.lat && d.lng) {
            const colors = { hot: '#00ff88', warm: '#ffaa00', cool: '#666' };
            const m = L.circleMarker([d.lat, d.lng], { radius: 5, fillColor: colors[d.desirability.level], color: '#000', weight: 1, fillOpacity: 0.9 });
            m.bindPopup('<div style="font:12px monospace;"><b>' + d.address.substring(0,40) + '</b><br>' + d.price + ' | ' + d.beds + ' | ' + (d.ber||'-') + '<br>Score: ' + d.desirability.score + '<br><a href="' + d.url + '" target="_blank">view →</a></div>');
            markers.addLayer(m);
        }
    });
}

function initCharts() {
    Chart.defaults.font.family = "'JetBrains Mono', monospace";
    Chart.defaults.font.size = 10;
    Chart.defaults.color = '#808080';

    const priceBuckets = [0,300,400,500,600,700,800,1000,1500,2000,10000];
    const priceLabels = ['<300k','300-400k','400-500k','500-600k','600-700k','700-800k','800k-1M','1-1.5M','1.5-2M','2M+'];
    const priceCounts = new Array(10).fill(0);
    filteredData.forEach(d => {
        const pk = d.priceNum / 1000;
        for (let i = 0; i < 9; i++) { if (pk >= priceBuckets[i] && pk < priceBuckets[i+1]) { priceCounts[i]++; break; } }
    });

    if (priceChart) priceChart.destroy();
    priceChart = new Chart(document.getElementById('priceChart'), {
        type: 'bar', data: { labels: priceLabels, datasets: [{ data: priceCounts, backgroundColor: '#00ff88', borderRadius: 2 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
            scales: { y: { grid: { color: '#2a2a2a' }, border: { display: false } }, x: { grid: { display: false }, border: { display: false } } } }
    });

    const areaData = Object.entries(areaStats).filter(([_,v]) => v.days.length >= 3)
        .map(([a, s]) => ({ area: a.substring(0,15), demand: Math.round(s.demandScore) }))
        .sort((a,b) => b.demand - a.demand).slice(0, 10);

    if (areaChart) areaChart.destroy();
    areaChart = new Chart(document.getElementById('areaChart'), {
        type: 'bar', data: { labels: areaData.map(a=>a.area), datasets: [{ data: areaData.map(a=>a.demand), backgroundColor: areaData.map((_,i) => i < 3 ? '#00ff88' : '#00aa55'), borderRadius: 2 }] },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
            scales: { x: { max: 100, grid: { color: '#2a2a2a' }, border: { display: false } }, y: { grid: { display: false }, border: { display: false } } } }
    });

    const daysBuckets = [0,7,30,60,90,180,365,9999];
    const daysLabels = ['<7d','7-30d','30-60d','60-90d','90-180d','180-365d','1yr+'];
    const daysCounts = new Array(7).fill(0);
    filteredData.forEach(d => { for (let i = 0; i < 7; i++) { if (d.daysNum >= daysBuckets[i] && d.daysNum < daysBuckets[i+1]) { daysCounts[i]++; break; } } });

    if (daysChart) daysChart.destroy();
    daysChart = new Chart(document.getElementById('daysChart'), {
        type: 'bar', data: { labels: daysLabels, datasets: [{ data: daysCounts, backgroundColor: daysCounts.map((_,i) => i < 2 ? '#00ff88' : i < 4 ? '#ffaa00' : '#ff4444'), borderRadius: 2 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
            scales: { y: { grid: { color: '#2a2a2a' }, border: { display: false } }, x: { grid: { display: false }, border: { display: false } } } }
    });
}

function renderTable() {
    const tbody = document.getElementById('tableBody'); tbody.replaceChildren();
    const sorted = [...filteredData].sort((a,b) => b.desirability.score - a.desirability.score);
    sorted.slice(0, 500).forEach(d => {
        const tr = document.createElement('tr');
        const des = d.desirability;
        const daysClass = d.daysNum >= 90 ? 'days-old' : d.daysNum <= 7 ? 'days-new' : '';
        const berClass = d.ber ? (d.ber[0] <= 'B' ? 'ber-good' : d.ber[0] <= 'C' ? 'ber-ok' : 'ber-bad') : '';

        const cells = [
            { html: '<span class="score score-' + des.level + '">' + des.score + '</span>' },
            { text: d.address.substring(0, 35) + (d.address.length > 35 ? '...' : '') },
            { text: d.price, cls: 'price' },
            { text: d.pricePerSqm > 0 ? '€' + d.pricePerSqm.toLocaleString() : '-' },
            { text: d.beds || '-' },
            { text: d.size_sqm || '-' },
            { text: d.property_type || '-' },
            { text: d.ber || '-', cls: berClass },
            { text: d.daysNum || '-', cls: daysClass },
            { html: '<a href="' + d.url + '" target="_blank">→</a>' }
        ];

        cells.forEach(c => {
            const td = document.createElement('td');
            if (c.cls) td.className = c.cls;
            if (c.html) td.innerHTML = c.html; else td.textContent = c.text;
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
}

function applyFilters() {
    filteredData = allData.filter(d => {
        const loc = document.getElementById('filterLocation').value.toLowerCase();
        const maxP = document.getElementById('filterPrice').value;
        const minB = document.getElementById('filterBeds').value;
        const type = document.getElementById('filterType').value;
        const ber = document.getElementById('filterBer').value;
        const des = document.getElementById('filterDesire').value;
        const days = document.getElementById('filterDays').value;

        if (loc && !d.address.toLowerCase().includes(loc)) return false;
        if (maxP && d.priceNum > parseInt(maxP)) return false;
        if (minB && d.bedsNum < parseInt(minB)) return false;
        if (type && !d.property_type?.includes(type)) return false;
        if (ber) { const o = ['A','B','C','D','E','F','G']; if (o.indexOf(d.ber?.[0]) > o.indexOf(ber)) return false; }
        if (des === 'hot' && d.desirability.level !== 'hot') return false;
        if (des === 'warm' && d.desirability.level === 'cool') return false;
        if (days === 'new' && d.daysNum > 7) return false;
        if (days === 'recent' && d.daysNum > 30) return false;
        if (days === 'stale' && d.daysNum < 90) return false;
        return true;
    });
    updateStats(); genInsights(); updateMapMarkers(); initCharts(); renderTable();
}

function resetFilters() {
    document.querySelectorAll('.filters select').forEach(s => s.value = '');
    document.getElementById('filterLocation').value = '';
    filteredData = [...allData]; applyFilters();
}

let sortDir = {};
function sortTable(col) {
    const keys = ['desirability.score','address','priceNum','pricePerSqm','bedsNum','sizeNum','property_type','ber','daysNum'];
    sortDir[col] = !sortDir[col];
    filteredData.sort((a, b) => {
        let va = col === 0 ? a.desirability.score : a[keys[col]];
        let vb = col === 0 ? b.desirability.score : b[keys[col]];
        if (typeof va === 'string') return sortDir[col] ? va.localeCompare(vb) : vb.localeCompare(va);
        return sortDir[col] ? va - vb : vb - va;
    });
    renderTable();
}

loadData();
</script>
</body>
</html>
